<div class="application-form-container">
  <div class="form-header">
    <h1 class="form-title">{{ isEditMode ? '補件申請' : '新增申請' }}</h1>
    <p class="form-subtitle">天星旅行社 B2B 文檔管理系統</p>
  </div>

  <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()" class="application-form">
    
    <!-- 護照與二寸照片上傳 -->
    <div class="form-section">
      <h2 class="section-title">證件與照片上傳</h2>
      <p class="section-description">請上傳護照資料頁和二寸大頭照，所有圖片需清晰可見</p>

      <div class="documents-upload-row">
        <!-- 護照上傳 (左側) -->
        <div class="passport-upload-column">
          <h3 class="column-title">護照資料頁</h3>
          <p class="column-description">請上傳護照資料頁（個人資料頁），需清晰可見所有文字和照片</p>
          
          <div class="passport-upload-item">
            <label class="passport-label">護照正面 <span class="required">*</span></label>
            <div class="image-upload-container">
              <input
                type="file"
                id="passport-front"
                (change)="onPassportImageSelected($event, 'front')"
                accept="image/jpeg,image/jpg,image/png"
                class="image-input"
                #passportFrontInput
              >
              
              <!-- 上傳區域 -->
              <div class="image-upload-area" 
                   *ngIf="!passportImages.front.preview"
                   (click)="passportFrontInput.click()"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onPassportDrop($event, 'front')"> 
                <div class="upload-placeholder">
                  <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M9 9H9.01M15 9H15.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <p class="upload-text">點擊或拖拽上傳護照正面</p>
                  <p class="upload-hint">護照資料頁，支援 JPG、PNG 格式，最大 10MB</p>
                </div>
              </div>

              <!-- 圖片預覽和編輯 -->
              <div class="image-preview-container" *ngIf="passportImages.front.preview">
                <div class="image-preview-header">
                  <span class="preview-title">護照正面預覽</span>
                  <div class="preview-actions">
                    <button type="button" class="action-btn ocr-btn" (click)="extractPassportInfo('front')" title="提取資訊" [disabled]="isExtractingInfo">
                      <svg *ngIf="!isExtractingInfo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 12L11 14L15 10M3 7H21M3 17H21M3 12H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <svg *ngIf="isExtractingInfo" class="spinner" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                          <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                          <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                        </circle>
                      </svg>
                    </button>
                    <button type="button" class="action-btn" (click)="rotatePassportImage('front')" title="旋轉">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4V10H7M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15A9 9 0 0 0 18.36 18.36L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button type="button" class="action-btn" (click)="cropPassportImage('front')" title="裁切">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 2V6H2V8H6V14H14V8H20V6H14V2H12V6H8V2H6ZM8 8V12H12V8H8Z" fill="currentColor"/>
                      </svg>
                    </button>
                    <button type="button" class="action-btn delete" (click)="removePassportImage('front')" title="刪除">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <div class="image-preview-area passport-page" [class.cropping]="passportImages.front.cropping">
                  <div class="image-container" 
                       [style.transform]="'rotate(' + passportImages.front.rotation + 'deg) scale(' + passportImages.front.scale + ')'">
                    <img [src]="passportImages.front.preview" 
                         alt="護照正面預覽"
                         class="preview-image"
                         (wheel)="onPassportImageWheel($event, 'front')"
                         (mousedown)="onPassportImageMouseDown($event, 'front')"
                         (mousemove)="onPassportImageMouseMove($event, 'front')"
                         (mouseup)="onPassportImageMouseUp($event, 'front')"
                         (mouseleave)="onPassportImageMouseUp($event, 'front')">
                  </div>
                  
                  <!-- 裁切框 -->
                  <div class="crop-overlay" *ngIf="passportImages.front.cropping">
                    <div class="crop-box" 
                         [style.left.px]="passportImages.front.cropBox.x"
                         [style.top.px]="passportImages.front.cropBox.y"
                         [style.width.px]="passportImages.front.cropBox.width"
                         [style.height.px]="passportImages.front.cropBox.height">
                      <div class="crop-handle crop-handle-tl" (mousedown)="onPassportCropHandleMouseDown($event, 'front', 'tl')"></div>
                      <div class="crop-handle crop-handle-tr" (mousedown)="onPassportCropHandleMouseDown($event, 'front', 'tr')"></div>
                      <div class="crop-handle crop-handle-bl" (mousedown)="onPassportCropHandleMouseDown($event, 'front', 'bl')"></div>
                      <div class="crop-handle crop-handle-br" (mousedown)="onPassportCropHandleMouseDown($event, 'front', 'br')"></div>
                    </div>
                  </div>
                </div>

                <!-- 縮放控制 -->
                <div class="image-controls">
                  <div class="zoom-control">
                    <button type="button" class="zoom-btn" (click)="zoomPassportImage('front', -0.1)">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                    <input type="range" 
                           class="zoom-slider"
                           min="0.5" 
                           max="3" 
                           step="0.1" 
                           [value]="passportImages.front.scale"
                           (input)="onPassportZoomChange($event, 'front')">
                    <button type="button" class="zoom-btn" (click)="zoomPassportImage('front', 0.1)">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11 8V14M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </div>
                  
                  <div class="crop-actions" *ngIf="passportImages.front.cropping">
                    <button type="button" class="crop-action-btn cancel" (click)="cancelPassportCrop('front')">取消</button>
                    <button type="button" class="crop-action-btn confirm" (click)="confirmPassportCrop('front')">確認裁切</button>
                  </div>
                </div>
              </div>

              <div class="error-message" *ngIf="getFieldError('passportFront')">
                {{ getFieldError('passportFront') }}
              </div>
            </div>
          </div>
        </div>

        <!-- 二寸照片上傳 (右側) -->
        <div class="photo-upload-column">
          <h3 class="column-title">二寸大頭照</h3>
          <p class="column-description">請上傳二寸大頭照，建議尺寸 413x531 像素（35mm x 45mm），背景為白色或淺色</p>
          
          <div class="photo-upload-item">
            <label class="photo-label">二寸照片 <span class="required">*</span></label>
            <div class="image-upload-container">
              <input
                type="file"
                id="passport-photo"
                (change)="onPhotoImageSelected($event, 'passport')"
                accept="image/jpeg,image/jpg,image/png"
                class="image-input"
                #passportPhotoInput
              >
              
              <!-- 上傳區域 -->
              <div class="image-upload-area" 
                   *ngIf="!photoImages.passport.preview"
                   (click)="passportPhotoInput.click()"
                   (dragover)="onDragOver($event)"
                   (dragleave)="onDragLeave($event)"
                   (drop)="onPhotoDrop($event, 'passport')">
                <div class="upload-placeholder">
                  <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 21V19C20 16.7909 18.2091 15 16 15H8C5.79086 15 4 16.7909 4 19V21M16 7C16 9.20914 14.2091 11 12 11C9.79086 11 8 9.20914 8 7C8 4.79086 9.79086 3 12 3C14.2091 3 16 4.79086 16 7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <p class="upload-text">點擊或拖拽上傳二寸照片</p>
                  <p class="upload-hint">建議尺寸 413x531 像素，最大 10MB</p>
                </div>
              </div>

              <!-- 圖片預覽和編輯 -->
              <div class="image-preview-container" *ngIf="photoImages.passport.preview">
                <div class="image-preview-header">
                  <span class="preview-title">二寸照片預覽</span>
                  <div class="preview-actions">
                    <button type="button" class="action-btn" (click)="rotatePhotoImage('passport')" title="旋轉">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M1 4V10H7M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15A9 9 0 0 0 18.36 18.36L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button type="button" class="action-btn" (click)="cropPhotoImage('passport')" title="裁切">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 2V6H2V8H6V14H14V8H20V6H14V2H12V6H8V2H6ZM8 8V12H12V8H8Z" fill="currentColor"/>
                      </svg>
                    </button>
                    <button type="button" class="action-btn delete" (click)="removePhotoImage('passport')" title="刪除">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <div class="image-preview-area passport-photo" [class.cropping]="photoImages.passport.cropping">
                  <div class="image-container" 
                       [style.transform]="'rotate(' + photoImages.passport.rotation + 'deg) scale(' + photoImages.passport.scale + ')'">
                    <img [src]="photoImages.passport.preview" 
                         alt="二寸照片預覽"
                         class="preview-image"
                         (wheel)="onPhotoImageWheel($event, 'passport')"
                         (mousedown)="onPhotoImageMouseDown($event, 'passport')"
                         (mousemove)="onPhotoImageMouseMove($event, 'passport')"
                         (mouseup)="onPhotoImageMouseUp($event, 'passport')"
                         (mouseleave)="onPhotoImageMouseUp($event, 'passport')">
                  </div>
                  
                  <!-- 裁切框 -->
                  <div class="crop-overlay" *ngIf="photoImages.passport.cropping">
                    <div class="crop-box passport-crop" 
                         [style.left.px]="photoImages.passport.cropBox.x"
                         [style.top.px]="photoImages.passport.cropBox.y"
                         [style.width.px]="photoImages.passport.cropBox.width"
                         [style.height.px]="photoImages.passport.cropBox.height">
                      <div class="crop-handle crop-handle-tl" (mousedown)="onPhotoCropHandleMouseDown($event, 'passport', 'tl')"></div>
                      <div class="crop-handle crop-handle-tr" (mousedown)="onPhotoCropHandleMouseDown($event, 'passport', 'tr')"></div>
                      <div class="crop-handle crop-handle-bl" (mousedown)="onPhotoCropHandleMouseDown($event, 'passport', 'bl')"></div>
                      <div class="crop-handle crop-handle-br" (mousedown)="onPhotoCropHandleMouseDown($event, 'passport', 'br')"></div>
                    </div>
                  </div>
                </div>

                <!-- 縮放控制 -->
                <div class="image-controls">
                  <div class="zoom-control">
                    <button type="button" class="zoom-btn" (click)="zoomPhotoImage('passport', -0.1)">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                    <input type="range" 
                           class="zoom-slider"
                           min="0.5" 
                           max="3" 
                           step="0.1" 
                           [value]="photoImages.passport.scale"
                           (input)="onPhotoZoomChange($event, 'passport')">
                    <button type="button" class="zoom-btn" (click)="zoomPhotoImage('passport', 0.1)">
                      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                        <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M11 8V14M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </div>
                  
                  <div class="crop-actions" *ngIf="photoImages.passport.cropping">
                    <button type="button" class="crop-action-btn cancel" (click)="cancelPhotoCrop('passport')">取消</button>
                    <button type="button" class="crop-action-btn confirm" (click)="confirmPhotoCrop('passport')">確認裁切</button>
                  </div>
                </div>
              </div>

              <div class="error-message" *ngIf="getFieldError('passportPhoto')">
                {{ getFieldError('passportPhoto') }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 身分證上傳 -->
    <div class="form-section">
      <h2 class="section-title">身分證上傳</h2>
      <p class="section-description">請上傳身分證正面和反面照片，支援 JPG、PNG 格式，建議尺寸 1200x800 像素</p>

      <div class="id-card-upload-grid">
        <!-- 身分證正面 -->
        <div class="id-card-upload-item">
          <label class="id-card-label">身分證正面 <span class="required">*</span></label>
          <div class="image-upload-container">
            <input
              type="file"
              id="id-card-front"
              (change)="onIdCardImageSelected($event, 'front')"
              accept="image/jpeg,image/jpg,image/png"
              class="image-input"
              #frontInput
            >
            
            <!-- 上傳區域 -->
            <div class="image-upload-area" 
                 *ngIf="!idCardImages.front.preview"
                 (click)="frontInput.click()"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event, 'front')">
              <div class="upload-placeholder">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14.2 3L4 13.2V20C4 20.5523 4.44772 21 5 21H11.8L22 10.8M14.2 3L19.8 8.6L22 10.8M14.2 3L10.8 6.4L19.8 8.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 12L12 8L16 12L12 16L8 12Z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="upload-text">點擊或拖拽上傳身分證正面</p>
                <p class="upload-hint">支援 JPG、PNG 格式，最大 10MB</p>
              </div>
            </div>

            <!-- 圖片預覽和編輯 -->
            <div class="image-preview-container" *ngIf="idCardImages.front.preview">
              <div class="image-preview-header">
                <span class="preview-title">身分證正面預覽</span>
                <div class="preview-actions">
                  <button type="button" class="action-btn" (click)="rotateImage('front')" title="旋轉">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M1 4V10H7M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15A9 9 0 0 0 18.36 18.36L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button type="button" class="action-btn" (click)="cropImage('front')" title="裁切">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M6 2V6H2V8H6V14H14V8H20V6H14V2H12V6H8V2H6ZM8 8V12H12V8H8Z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button type="button" class="action-btn delete" (click)="removeIdCardImage('front')" title="刪除">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="image-preview-area" [class.cropping]="idCardImages.front.cropping">
                <div class="image-container" 
                     [style.transform]="'rotate(' + idCardImages.front.rotation + 'deg) scale(' + idCardImages.front.scale + ')'">
                  <img [src]="idCardImages.front.preview" 
                       alt="身分證正面預覽"
                       class="preview-image"
                       (wheel)="onImageWheel($event, 'front')"
                       (mousedown)="onImageMouseDown($event, 'front')"
                       (mousemove)="onImageMouseMove($event, 'front')"
                       (mouseup)="onImageMouseUp($event, 'front')"
                       (mouseleave)="onImageMouseUp($event, 'front')">
                </div>
                
                <!-- 裁切框 -->
                <div class="crop-overlay" *ngIf="idCardImages.front.cropping">
                  <div class="crop-box" 
                       [style.left.px]="idCardImages.front.cropBox.x"
                       [style.top.px]="idCardImages.front.cropBox.y"
                       [style.width.px]="idCardImages.front.cropBox.width"
                       [style.height.px]="idCardImages.front.cropBox.height">
                    <div class="crop-handle crop-handle-tl" (mousedown)="onCropHandleMouseDown($event, 'front', 'tl')"></div>
                    <div class="crop-handle crop-handle-tr" (mousedown)="onCropHandleMouseDown($event, 'front', 'tr')"></div>
                    <div class="crop-handle crop-handle-bl" (mousedown)="onCropHandleMouseDown($event, 'front', 'bl')"></div>
                    <div class="crop-handle crop-handle-br" (mousedown)="onCropHandleMouseDown($event, 'front', 'br')"></div>
                  </div>
                </div>
              </div>

              <!-- 縮放控制 -->
              <div class="image-controls">
                <div class="zoom-control">
                  <button type="button" class="zoom-btn" (click)="zoomImage('front', -0.1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                      <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <input type="range" 
                         class="zoom-slider"
                         min="0.5" 
                         max="3" 
                         step="0.1" 
                         [value]="idCardImages.front.scale"
                         (input)="onZoomChange($event, 'front')">
                  <button type="button" class="zoom-btn" (click)="zoomImage('front', 0.1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                      <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M11 8V14M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </div>
                
                <div class="crop-actions" *ngIf="idCardImages.front.cropping">
                  <button type="button" class="crop-action-btn cancel" (click)="cancelCrop('front')">取消</button>
                  <button type="button" class="crop-action-btn confirm" (click)="confirmCrop('front')">確認裁切</button>
                </div>
              </div>
            </div>

            <div class="error-message" *ngIf="getFieldError('idCardFront')">
              {{ getFieldError('idCardFront') }}
            </div>
          </div>
        </div>

        <!-- 身分證反面 -->
        <div class="id-card-upload-item">
          <label class="id-card-label">身分證反面 <span class="required">*</span></label>
          <div class="image-upload-container">
            <input
              type="file"
              id="id-card-back"
              (change)="onIdCardImageSelected($event, 'back')"
              accept="image/jpeg,image/jpg,image/png"
              class="image-input"
              #backInput
            >
            
            <!-- 上傳區域 -->
            <div class="image-upload-area" 
                 *ngIf="!idCardImages.back.preview"
                 (click)="backInput.click()"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event, 'back')">
              <div class="upload-placeholder">
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14.2 3L4 13.2V20C4 20.5523 4.44772 21 5 21H11.8L22 10.8M14.2 3L19.8 8.6L22 10.8M14.2 3L10.8 6.4L19.8 8.6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 12L12 8L16 12L12 16L8 12Z" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="upload-text">點擊或拖拽上傳身分證反面</p>
                <p class="upload-hint">支援 JPG、PNG 格式，最大 10MB</p>
              </div>
            </div>

            <!-- 圖片預覽和編輯 -->
            <div class="image-preview-container" *ngIf="idCardImages.back.preview">
              <div class="image-preview-header">
                <span class="preview-title">身分證反面預覽</span>
                <div class="preview-actions">
                  <button type="button" class="action-btn" (click)="rotateImage('back')" title="旋轉">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M1 4V10H7M23 20V14H17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10M3.51 15A9 9 0 0 0 18.36 18.36L23 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                  <button type="button" class="action-btn" (click)="cropImage('back')" title="裁切">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M6 2V6H2V8H6V14H14V8H20V6H14V2H12V6H8V2H6ZM8 8V12H12V8H8Z" fill="currentColor"/>
                    </svg>
                  </button>
                  <button type="button" class="action-btn delete" (click)="removeIdCardImage('back')" title="刪除">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
              
              <div class="image-preview-area" [class.cropping]="idCardImages.back.cropping">
                <div class="image-container" 
                     [style.transform]="'rotate(' + idCardImages.back.rotation + 'deg) scale(' + idCardImages.back.scale + ')'">
                  <img [src]="idCardImages.back.preview" 
                       alt="身分證反面預覽"
                       class="preview-image"
                       (wheel)="onImageWheel($event, 'back')"
                       (mousedown)="onImageMouseDown($event, 'back')"
                       (mousemove)="onImageMouseMove($event, 'back')"
                       (mouseup)="onImageMouseUp($event, 'back')"
                       (mouseleave)="onImageMouseUp($event, 'back')">
                </div>
                
                <!-- 裁切框 -->
                <div class="crop-overlay" *ngIf="idCardImages.back.cropping">
                  <div class="crop-box" 
                       [style.left.px]="idCardImages.back.cropBox.x"
                       [style.top.px]="idCardImages.back.cropBox.y"
                       [style.width.px]="idCardImages.back.cropBox.width"
                       [style.height.px]="idCardImages.back.cropBox.height">
                    <div class="crop-handle crop-handle-tl" (mousedown)="onCropHandleMouseDown($event, 'back', 'tl')"></div>
                    <div class="crop-handle crop-handle-tr" (mousedown)="onCropHandleMouseDown($event, 'back', 'tr')"></div>
                    <div class="crop-handle crop-handle-bl" (mousedown)="onCropHandleMouseDown($event, 'back', 'bl')"></div>
                    <div class="crop-handle crop-handle-br" (mousedown)="onCropHandleMouseDown($event, 'back', 'br')"></div>
                  </div>
                </div>
              </div>

              <!-- 縮放控制 -->
              <div class="image-controls">
                <div class="zoom-control">
                  <button type="button" class="zoom-btn" (click)="zoomImage('back', -0.1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                      <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                  <input type="range" 
                         class="zoom-slider"
                         min="0.5" 
                         max="3" 
                         step="0.1" 
                         [value]="idCardImages.back.scale"
                         (input)="onZoomChange($event, 'back')">
                  <button type="button" class="zoom-btn" (click)="zoomImage('back', 0.1)">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                      <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M11 8V14M8 11H14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                  </button>
                </div>
                
                <div class="crop-actions" *ngIf="idCardImages.back.cropping">
                  <button type="button" class="crop-action-btn cancel" (click)="cancelCrop('back')">取消</button>
                  <button type="button" class="crop-action-btn confirm" (click)="confirmCrop('back')">確認裁切</button>
                </div>
              </div>
            </div>

            <div class="error-message" *ngIf="getFieldError('idCardBack')">
              {{ getFieldError('idCardBack') }}
            </div>
          </div>
        </div>
      </div>
    </div>

   

    <!-- 基本資訊 -->
    <div class="form-section">
      <h2 class="section-title">基本資訊</h2>

      <div class="form-row">
        <!-- 辦理類別 -->
        <div class="form-group">
          <label class="form-label">辦理類別 <span class="required">*</span></label>
          <select formControlName="type" class="form-select">
            <option value="">請選擇辦理類別</option>
            <option *ngFor="let type of applicationTypes" [value]="type">{{ type }}</option>
          </select>
          <div class="error-message" *ngIf="getFieldError('type')">
            {{ getFieldError('type') }}
          </div>
        </div>

        <!-- 辦理速度 -->
        <div class="form-group">
          <label class="form-label">辦理速度 <span class="required">*</span></label>
          <select formControlName="speed" class="form-select">
            <option *ngFor="let speed of processingSpeeds" [value]="speed">{{ speed }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <!-- 辦理日期 -->
        <div class="form-group">
          <label class="form-label">辦理日期 <span class="required">*</span></label>
          <input
            type="date"
            formControlName="applicationDate"
            class="form-input"
            [class.error]="getFieldError('applicationDate')"
          >
          <div class="error-message" *ngIf="getFieldError('applicationDate')">
            {{ getFieldError('applicationDate') }}
          </div>
        </div>

        <!-- 顧客姓名 -->
        <div class="form-group">
          <label class="form-label">顧客姓名 <span class="required">*</span></label>
          <input
            type="text"
            formControlName="customerName"
            class="form-input"
            placeholder="請輸入顧客姓名"
            [class.error]="getFieldError('customerName')"
          >
          <div class="error-message" *ngIf="getFieldError('customerName')">
            {{ getFieldError('customerName') }}
          </div>
        </div>
      </div>

      <!-- 個人詳細資料 -->
      <div class="form-section">
        <h2 class="section-title">個人詳細資料</h2>
        <p class="section-description">請填寫完整的個人資料，用於辦理護照申請</p>

        <div class="form-row">
          <!-- 中文姓 -->
          <div class="form-group">
            <label class="form-label">中文姓 <span class="required">*</span></label>
            <input
              type="text"
              formControlName="chineseLastName"
              class="form-input"
              placeholder="請輸入中文姓"
              [class.error]="getFieldError('chineseLastName')"
            >
            <div class="error-message" *ngIf="getFieldError('chineseLastName')">
              {{ getFieldError('chineseLastName') }}
            </div>
          </div>

          <!-- 中文名 -->
          <div class="form-group">
            <label class="form-label">中文名 <span class="required">*</span></label>
            <input
              type="text"
              formControlName="chineseFirstName"
              class="form-input"
              placeholder="請輸入中文名"
              [class.error]="getFieldError('chineseFirstName')"
            >
            <div class="error-message" *ngIf="getFieldError('chineseFirstName')">
              {{ getFieldError('chineseFirstName') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <!-- 英文姓 -->
          <div class="form-group">
            <label class="form-label">英文姓 <span class="required">*</span></label>
            <input
              type="text"
              formControlName="englishLastName"
              class="form-input"
              placeholder="請輸入英文姓 (Last Name)"
              [class.error]="getFieldError('englishLastName')"
            >
            <div class="error-message" *ngIf="getFieldError('englishLastName')">
              {{ getFieldError('englishLastName') }}
            </div>
          </div>

          <!-- 英文名 -->
          <div class="form-group">
            <label class="form-label">英文名 <span class="required">*</span></label>
            <input
              type="text"
              formControlName="englishFirstName"
              class="form-input"
              placeholder="請輸入英文名 (First Name)"
              [class.error]="getFieldError('englishFirstName')"
            >
            <div class="error-message" *ngIf="getFieldError('englishFirstName')">
              {{ getFieldError('englishFirstName') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <!-- 身分證字號 -->
          <div class="form-group">
            <label class="form-label">身分證字號 <span class="required">*</span></label>
            <input
              type="text"
              formControlName="nationalId"
              class="form-input"
              placeholder="請輸入身分證字號"
              maxlength="10"
              [class.error]="getFieldError('nationalId')"
            >
            <div class="error-message" *ngIf="getFieldError('nationalId')">
              {{ getFieldError('nationalId') }}
            </div>
          </div>

          <!-- 性別 -->
          <div class="form-group">
            <label class="form-label">性別 <span class="required">*</span></label>
            <select formControlName="gender" class="form-select" [class.error]="getFieldError('gender')">
              <option value="">請選擇性別</option>
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
            <div class="error-message" *ngIf="getFieldError('gender')">
              {{ getFieldError('gender') }}
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- 附件上傳 -->
    <div class="form-section">
      <h2 class="section-title">附件上傳</h2>
      <p class="section-description">請上傳相關文件，支援多檔案上傳，單檔案大小限制 10MB</p>

      <div class="attachments-grid">
        <div class="attachment-item" *ngFor="let type of attachmentTypes">
          <label class="attachment-label">{{ type }}</label>
          <div class="file-upload-area">
            <input
              type="file"
              [id]="'file-' + type"
              multiple
              (change)="onFileSelected($event, type)"
              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              class="file-input"
            >
            <label [for]="'file-' + type" class="file-upload-btn">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              選擇檔案
            </label>
          </div>
        </div>
      </div>

      <!-- 已上傳的附件列表 -->
      <div class="uploaded-attachments" *ngIf="isEditMode && existingApplication && existingApplication.attachments.length > 0">
        <h3 class="attachments-title">已上傳的附件</h3>
        <div class="attachments-list">
          <div class="attachment-card" *ngFor="let attachment of existingApplication.attachments">
            <div class="attachment-info">
              <div class="attachment-type">{{ attachment.type }}</div>
              <div class="attachment-name">{{ attachment.name }}</div>
              <div class="attachment-size">{{ getFileSizeString(attachment.size) }}</div>
              <div class="attachment-date">{{ attachment.uploadDate | date:'yyyy-MM-dd HH:mm' }}</div>
            </div>
            <button
              type="button"
              class="delete-btn"
              (click)="removeAttachment(attachment.id)"
              title="刪除附件"
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- 待上傳的附件列表 -->
      <div class="uploaded-attachments" *ngIf="!isEditMode && pendingAttachments.length > 0">
        <h3 class="attachments-title">待上傳的附件</h3>
        <div class="attachments-list">
          <ng-container *ngFor="let pa of pendingAttachments; let paIndex = index">
            <div class="attachment-card" *ngFor="let file of pa.files; let fileIndex = index">
              <div class="attachment-info">
                <div class="attachment-type">{{ pa.type }}</div>
                <div class="attachment-name">{{ file.name }}</div>
                <div class="attachment-size">{{ getFileSizeString(file.size) }}</div>
              </div>
              <button
                type="button"
                class="delete-btn"
                (click)="removePendingAttachment(paIndex, fileIndex)"
                title="刪除附件"
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- 上傳進度 -->
      <div class="upload-progress" *ngIf="hasUploadProgress()">
        <h3 class="progress-title">上傳進度</h3>
        <div class="progress-list">
          <div class="progress-item" *ngFor="let fileName of getUploadProgressKeys()">
            <span class="file-name">{{ fileName }}</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress[fileName]"></div>
            </div>
            <span class="progress-text">{{ uploadProgress[fileName] }}%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 表單按鈕 -->
    <div class="form-actions">
      <button type="button" class="cancel-btn" (click)="cancel()">取消</button>
      <button type="submit" class="submit-btn" [disabled]="isLoading">
        <span *ngIf="!isLoading">{{ isEditMode ? '更新申請' : '提交申請' }}</span>
        <span *ngIf="isLoading" class="loading-text">
          <svg class="loading-spinner" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
              <animate attributeName="stroke-dashoffset" dur="1s" repeatCount="indefinite" values="31.416;0"/>
            </circle>
          </svg>
          {{ isEditMode ? '更新中...' : '提交中...' }}
        </span>
      </button>
    </div>
  </form>
</div>
