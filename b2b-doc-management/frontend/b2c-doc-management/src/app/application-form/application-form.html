<div class="application-form-container">
  <div class="form-header">
    <h1 class="form-title">{{ isEditMode ? '補件申請' : '新增申請' }}</h1>
    <p class="form-subtitle">天星旅行社 B2B 文檔管理系統</p>
  </div>

  <form [formGroup]="applicationForm" (ngSubmit)="onSubmit()" class="application-form">
    <!-- 基本資訊 -->
    <div class="form-section">
      <h2 class="section-title">基本資訊</h2>

      <div class="form-row">
        <!-- 辦理類別 -->
        <div class="form-group">
          <label class="form-label">辦理類別 <span class="required">*</span></label>
          <select formControlName="type" class="form-select">
            <option value="">請選擇辦理類別</option>
            <option *ngFor="let type of applicationTypes" [value]="type">{{ type }}</option>
          </select>
          <div class="error-message" *ngIf="getFieldError('type')">
            {{ getFieldError('type') }}
          </div>
        </div>

        <!-- 辦理速度 -->
        <div class="form-group">
          <label class="form-label">辦理速度 <span class="required">*</span></label>
          <select formControlName="speed" class="form-select">
            <option *ngFor="let speed of processingSpeeds" [value]="speed">{{ speed }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <!-- 辦理日期 -->
        <div class="form-group">
          <label class="form-label">辦理日期 <span class="required">*</span></label>
          <input
            type="date"
            formControlName="applicationDate"
            class="form-input"
            [class.error]="getFieldError('applicationDate')"
          >
          <div class="error-message" *ngIf="getFieldError('applicationDate')">
            {{ getFieldError('applicationDate') }}
          </div>
        </div>

        <!-- 顧客姓名 -->
        <div class="form-group">
          <label class="form-label">顧客姓名 <span class="required">*</span></label>
          <input
            type="text"
            formControlName="customerName"
            class="form-input"
            placeholder="請輸入顧客姓名"
            [class.error]="getFieldError('customerName')"
          >
          <div class="error-message" *ngIf="getFieldError('customerName')">
            {{ getFieldError('customerName') }}
          </div>
        </div>
      </div>
    </div>

    <!-- 附件上傳 -->
    <div class="form-section">
      <h2 class="section-title">附件上傳</h2>
      <p class="section-description">請上傳相關文件，支援多檔案上傳，單檔案大小限制 10MB</p>

      <div class="attachments-grid">
        <div class="attachment-item" *ngFor="let type of attachmentTypes">
          <label class="attachment-label">{{ type }}</label>
          <div class="file-upload-area">
            <input
              type="file"
              [id]="'file-' + type"
              multiple
              (change)="onFileSelected($event, type)"
              accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
              class="file-input"
            >
            <label [for]="'file-' + type" class="file-upload-btn">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              選擇檔案
            </label>
          </div>
        </div>
      </div>

      <!-- 已上傳的附件列表 -->
      <div class="uploaded-attachments" *ngIf="isEditMode && existingApplication && existingApplication.attachments.length > 0">
        <h3 class="attachments-title">已上傳的附件</h3>
        <div class="attachments-list">
          <div class="attachment-card" *ngFor="let attachment of existingApplication.attachments">
            <div class="attachment-info">
              <div class="attachment-type">{{ attachment.type }}</div>
              <div class="attachment-name">{{ attachment.name }}</div>
              <div class="attachment-size">{{ getFileSizeString(attachment.size) }}</div>
              <div class="attachment-date">{{ attachment.uploadDate | date:'yyyy-MM-dd HH:mm' }}</div>
            </div>
            <button
              type="button"
              class="delete-btn"
              (click)="removeAttachment(attachment.id)"
              title="刪除附件"
            >
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- 待上傳的附件列表 -->
      <div class="uploaded-attachments" *ngIf="!isEditMode && pendingAttachments.length > 0">
        <h3 class="attachments-title">待上傳的附件</h3>
        <div class="attachments-list">
          <ng-container *ngFor="let pa of pendingAttachments; let paIndex = index">
            <div class="attachment-card" *ngFor="let file of pa.files; let fileIndex = index">
              <div class="attachment-info">
                <div class="attachment-type">{{ pa.type }}</div>
                <div class="attachment-name">{{ file.name }}</div>
                <div class="attachment-size">{{ getFileSizeString(file.size) }}</div>
              </div>
              <button
                type="button"
                class="delete-btn"
                (click)="removePendingAttachment(paIndex, fileIndex)"
                title="刪除附件"
              >
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M19 7L5 7M10 11V17M14 11V17M6 7V19C6 20.1046 6.89543 21 8 21H16C17.1046 21 18 20.1046 18 19V7M9 7V4C9 2.89543 9.89543 2 11 2H13C14.1046 2 15 2.89543 15 4V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- 上傳進度 -->
      <div class="upload-progress" *ngIf="hasUploadProgress()">
        <h3 class="progress-title">上傳進度</h3>
        <div class="progress-list">
          <div class="progress-item" *ngFor="let fileName of getUploadProgressKeys()">
            <span class="file-name">{{ fileName }}</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress[fileName]"></div>
            </div>
            <span class="progress-text">{{ uploadProgress[fileName] }}%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 表單按鈕 -->
    <div class="form-actions">
      <button type="button" class="cancel-btn" (click)="cancel()">取消</button>
      <button type="submit" class="submit-btn" [disabled]="isLoading">
        <span *ngIf="!isLoading">{{ isEditMode ? '更新申請' : '提交申請' }}</span>
        <span *ngIf="isLoading" class="loading-text">
          <svg class="loading-spinner" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="31.416" stroke-dashoffset="31.416">
              <animate attributeName="stroke-dashoffset" dur="1s" repeatCount="indefinite" values="31.416;0"/>
            </circle>
          </svg>
          {{ isEditMode ? '更新中...' : '提交中...' }}
        </span>
      </button>
    </div>
  </form>
</div>
